version: 2

jobs:
    build:
        docker:
            - image: circleci/golang:1.11
              environment:
                GO111MODULE: "ON"
        working_directory: /go/src/github.com/banzaicloud/jwt-to-rbac

        steps:
            - checkout

            - restore_cache:
                  name: Restore build dependencies
                  keys:
                      - build-deps-v1-{{ .Branch }}-{{ checksum "Makefile" }}

            - restore_cache:
                name: Restore dependencies
                keys:
                  - go-mod-v1-{{ .Branch }}-{{ checksum "go.sum" }}

            - run:
                  name: Install dependencies
                  command: make vendor

            - save_cache:
                name: Save dependencies
                key: go-mod-v1-{{ .Branch }}-{{ checksum "go.sum" }}
                paths:
                  - "/go/pkg/mod"

            - run:
                  name: Build
                  command: make build

            - run:
                  name: Run linter
                  command: make lint

            - run:
                  name: Run tests
                  command: make test

            - save_cache:
                  name: Save build dependencies
                  key: build-deps-v1-{{ .Branch }}-{{ checksum "Makefile" }}
                  paths:
                      - bin/
